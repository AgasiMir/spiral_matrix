# ===========================
# Тесты: get_matrix (интеграционные)
# ===========================

@pytest.mark.asyncio
async def test_get_matrix_success():
    with aioresponses() as m:
        m.get(SOURSE_URL, status=200, body=MOCK_MATRIX_TEXT)
        result = await get_matrix(SOURSE_URL)
        expected = [1, 5, 9, 13, 14, 15, 16, 12, 8, 4, 3, 2, 6, 10, 11, 7]
        assert result == expected


@pytest.mark.asyncio
async def test_get_matrix_with_retry_success_after_fail():
    with aioresponses() as m:
        # Первая попытка — ошибка, вторая — успех
        m.get(SOURSE_URL, status=500)
        m.get(SOURSE_URL, status=200, body=MOCK_MATRIX_TEXT)

        with patch("get_matrix.asyncio.sleep", new_callable=AsyncMock):  # подавляем задержку
            result = await get_matrix(SOURSE_URL)

        expected = [1, 5, 9, 13, 14, 15, 16, 12, 8, 4, 3, 2, 6, 10, 11, 7]
        assert result == expected


@pytest.mark.asyncio
async def test_get_matrix_all_retries_fail():
    with aioresponses() as m:
        m.get(SOURSE_URL, status=500)
        m.get(SOURSE_URL, status=500)
        m.get(SOURSE_URL, status=500)

        with patch("get_matrix.asyncio.sleep", new_callable=AsyncMock):
            with pytest.raises(Exception) as exc_info:
                await get_matrix(SOURSE_URL)

        assert "HTTP 500" in str(exc_info.value)


@pytest.mark.asyncio
async def test_get_matrix_parsing_error():
    invalid_body = "1 | 2\n---\nabc | def"  # нечисловые данные
    with aioresponses() as m:
        m.get(SOURSE_URL, status=200, body=invalid_body)
        with pytest.raises(ValueError, match="Ошибка при парсинге матрицы"):
            await get_matrix(SOURSE_URL)


# ===========================
# Дополнительно: логирование (опционально)
# ===========================

@pytest.mark.asyncio
async def test_get_matrix_logs(caplog):
    with aioresponses() as m:
        m.get(SOURSE_URL, status=200, body=MOCK_MATRIX_TEXT)
        with caplog.at_level("INFO"):
            result = await get_matrix(SOURSE_URL)

        assert "Загрузка данных с" in caplog.text
        assert "Матрица успешно распаршена" in caplog.text
        assert "Спиральный обход завершён" in caplog.text
        assert len(result) > 0